<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä¸“ä¸šçº§ Â· æœŸè´§æ™ºèƒ½é¢„æµ‹ç³»ç»Ÿ (WOAä¼˜åŒ–ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        :root {
            --metal-gradient: linear-gradient(135deg, #ffd700, #ffed4e);
            --energy-gradient: linear-gradient(135deg, #333333, #000000);
            --agri-gradient: linear-gradient(135deg, #56ab2f, #a8e6cf);
            --chem-gradient: linear-gradient(135deg, #6a11cb, #2575fc);
        }
        
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 2rem 0; }
        .main-container { background: rgba(255,255,255,0.97); border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); }
        .card-hover { transition: all 0.3s ease; cursor: pointer; }
        .card-hover:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 25px 50px rgba(0,0,0,0.25) !important; }
        .symbol-card { border: none; border-radius: 16px; overflow: hidden; position: relative; height: 100%; }
        
        .metal-bg { background: var(--metal-gradient); color: #000; }
        .energy-bg { background: var(--energy-gradient); color: white; }
        .agri-bg { background: var(--agri-gradient); color: #000; }
        .chem-bg { background: var(--chem-gradient); color: white; }
        
        .price-tag { font-size: 1.4rem; font-weight: bold; }
        .change-up { color: #dc3545; }
        .change-down { color: #28a745; }
        .badge-volume { font-size: 0.8rem; opacity: 0.9; }
        .icon-3d { font-size: 2.5rem; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
        .price-chart-card { border-radius: 20px; overflow: hidden; }
        
        .model-badge { 
            padding: 3px 10px; 
            border-radius: 12px; 
            font-size: 0.8rem; 
            font-weight: bold;
            color: white;
        }
        
        .badge-lstm-map {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
        }
        
        .badge-rf-mip-lstm {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .badge-woa {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
        }
        
        .confidence-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107);
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        .refresh-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .realtime-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .algorithm-card {
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .algorithm-card:hover {
            border-color: #6c757d;
        }
        
        .algorithm-card.active {
            border-color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .algorithm-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .optimization-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff6b6b;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .optimization-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .status-running {
            background-color: #d1ecf1;
            border-left: 4px solid #0dcaf0;
        }
        
        .status-completed {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .status-failed {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="main-container shadow-lg">
        <div class="bg-primary text-white p-5 text-center position-relative">
            <div class="position-absolute top-0 end-0 m-3">
                <span class="model-badge badge-woa">WOAæ™ºèƒ½ä¼˜åŒ–</span>
                <span class="model-badge badge-lstm-map ms-1">åŒç®—æ³•</span>
            </div>
            <h1 class="mb-2"><i class="bi bi-cpu-fill me-3"></i>æœŸè´§æ™ºèƒ½é¢„æµ‹ç³»ç»Ÿ</h1>
            <p class="mb-0 opacity-90">WOAä¼˜åŒ– + LSTM-MAP + RF-MIP-LSTM Â· æ™ºèƒ½è¶…å‚æ•°è°ƒä¼˜</p>
        </div>

        <div class="row g-0">
            <!-- å·¦ä¾§ï¼šçƒ­é—¨å“ç§å¡ç‰‡ -->
            <div class="col-lg-4 bg-light p-4" style="max-height: 90vh; overflow-y: auto;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-primary mb-0">
                        <i class="bi bi-fire"></i> å®æ—¶è¡Œæƒ…ç›‘æ§
                    </h4>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshAllRealtime()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                    </button>
                </div>
                <div class="mb-3 text-center">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> ç‚¹å‡»å“ç§è·å–AIé¢„æµ‹
                    </small>
                </div>
                <div class="row g-3">
                    {% macro variety_card(name, code, icon, bg_class, category) %}
                    <div class="col-6">
                        <div class="symbol-card card-hover shadow {{ bg_class }} text-center p-3 position-relative" 
                             onclick="quickPredict('{{ code }}')"
                             data-category="{{ category }}"
                             data-symbol="{{ code }}"
                             oncontextmenu="showRealtimeDetail('{{ code }}'); return false;">
                            
                            <!-- å®æ—¶è¡Œæƒ…æ ‡è¯† -->
                            <span class="realtime-badge">å®æ—¶</span>
                            
                            <!-- åˆ·æ–°æŒ‰é’® -->
                            <div class="refresh-btn" onclick="refreshSymbol('{{ code }}', event)">
                                <i class="bi bi-arrow-clockwise text-white"></i>
                            </div>
                            
                            <div class="icon-3d mb-2">{{ icon }}</div>
                            <h6 class="mb-2">{{ name }}</h6>
                            <code class="bg-light px-2 py-1 rounded fs-6">{{ code }}</code>
                            
                            {% if category == 'metal' %}
                            <span class="badge bg-warning text-dark mt-1">è´µé‡‘å±</span>
                            {% elif category == 'energy' %}
                            <span class="badge bg-dark mt-1">èƒ½æº</span>
                            {% elif category == 'agri' %}
                            <span class="badge bg-success mt-1">å†œäº§å“</span>
                            {% else %}
                            <span class="badge bg-info mt-1">åŒ–å·¥</span>
                            {% endif %}

                            <!-- å®æ—¶è¡Œæƒ…æ•°æ® -->
                            <div class="mt-3 realtime-data" id="realtime-{{ code }}">
                                {% if realtime_data and realtime_data[code] %}
                                <div class="price-tag">{{ "%.2f"|format(realtime_data[code].current_price) }}</div>
                                <div class="{% if realtime_data[code].change >= 0 %}change-up fw-bold{% else %}change-down fw-bold{% endif %} fs-6">
                                    {% if realtime_data[code].change >= 0 %}â†‘{% else %}â†“{% endif %}
                                    {{ "%.2f"|format(realtime_data[code].change|abs) }} 
                                    ({{ "%.2f"|format(realtime_data[code].change_pct) }}%)
                                </div>
                                <div class="badge badge-volume bg-light text-dark mt-1">
                                    é‡ {{ (realtime_data[code].volume // 10000)|int if realtime_data[code].volume else 0 }}ä¸‡
                                </div>
                                {% elif data and data.symbol == code %}
                                <div class="price-tag">{{ "%.2f"|format(data.current_price) }}</div>
                                <div class="{% if data.change >= 0 %}change-up fw-bold{% else %}change-down fw-bold{% endif %} fs-6">
                                    {% if data.change >= 0 %}â†‘{% else %}â†“{% endif %}
                                    {{ "%.2f"|format(data.change|abs) }} 
                                    ({{ "%.2f"|format(data.change_pct) }}%)
                                </div>
                                <div class="badge badge-volume bg-light text-dark mt-1">
                                    é‡ {{ (data.volume // 10000)|int if data.volume else 0 }}ä¸‡
                                </div>
                                {% else %}
                                <div class="mt-3 opacity-75 small">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    åŠ è½½å®æ—¶æ•°æ®...
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if data and data.symbol == code %}
                            <div class="mt-2 text-warning small fw-bold">
                                <i class="bi bi-lightning-charge"></i> AIé¢„æµ‹å·²ç”Ÿæˆ
                            </div>
                            {% else %}
                            <div class="mt-2 opacity-75 small">
                                <i class="bi bi-robot"></i> ç‚¹å‡»è¿›è¡ŒAIé¢„æµ‹
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endmacro %}

                    {{ variety_card('é»„é‡‘', 'AU0', 'ğŸª™', 'metal-bg', 'metal') }}
                    {{ variety_card('ç™½é“¶', 'AG0', 'ğŸ¥ˆ', 'metal-bg', 'metal') }}
                    {{ variety_card('æ²ªé“œ', 'CU0', 'ğŸ› ï¸', 'metal-bg', 'metal') }}
                    {{ variety_card('èºçº¹é’¢', 'RB0', 'ğŸ”©', 'metal-bg', 'metal') }}
                    {{ variety_card('åŸæ²¹', 'SC0', 'ğŸ›¢ï¸', 'energy-bg', 'energy') }}
                    {{ variety_card('æ²¥é’', 'BU0', 'ğŸ›£ï¸', 'energy-bg', 'energy') }}
                    {{ variety_card('è±†ç²•', 'M0', 'ğŸŒ±', 'agri-bg', 'agri') }}
                    {{ variety_card('PTA', 'TA0', 'ğŸ§ª', 'chem-bg', 'chem') }}
                    {{ variety_card('ç”²é†‡', 'MA0', 'âš—ï¸', 'chem-bg', 'chem') }}
                    {{ variety_card('æ²ªé•', 'NI0', 'ğŸ”©', 'metal-bg', 'metal') }}
                </div>
                
                <!-- ç§»é™¤åŸå·¦ä¾§çš„WOAä¼˜åŒ–çŠ¶æ€åŒºåŸŸ -->
            </div>

            <!-- å³ä¾§ï¼šä¸»æ“ä½œåŒº -->
            <div class="col-lg-8 p-5">
                {% if not data and not error %}
                <div class="alert alert-info mb-4">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="bi bi-info-circle fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">WOAæ™ºèƒ½ä¼˜åŒ–ç³»ç»Ÿ</h5>
                            <p class="mb-1"><strong>é²¸é±¼ä¼˜åŒ–ç®—æ³•(WOA)ï¼š</strong>æ™ºèƒ½æœç´¢æœ€ä½³è¶…å‚æ•°ç»„åˆ</p>
                            <p class="mb-1"><strong>LSTM-MAPï¼š</strong>ä¸“æ³¨ä»·æ ¼æ—¶åºï¼Œè®­ç»ƒå¿«é€Ÿ</p>
                            <p class="mb-0"><strong>RF-MIP-LSTMï¼š</strong>å¤šç‰¹å¾åˆ†æï¼Œç²¾åº¦æ›´é«˜</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if error %}
                <div class="alert alert-danger mb-4">
                    <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
                </div>
                {% endif %}

                <!-- ç®—æ³•é€‰æ‹©åŒºåŸŸ -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <i class="bi bi-gear"></i> é€‰æ‹©é¢„æµ‹ç®—æ³•
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="algorithm-card card text-center p-3 {% if not algorithm or algorithm == 'lstm_map' %}active{% endif %}" 
                                     onclick="selectAlgorithm('lstm_map')">
                                    {% if optimized_params.lstm_map.has_params %}
                                    <span class="optimization-badge">WOAä¼˜åŒ–</span>
                                    {% endif %}
                                    <div class="algorithm-icon text-primary">
                                        <i class="bi bi-lightning-charge"></i>
                                    </div>
                                    <h5>LSTM-MAP</h5>
                                    <p class="small text-muted mb-2">åŒå‘LSTM + å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶</p>
                                    <div class="d-flex justify-content-center">
                                        <span class="badge bg-primary me-1">å¿«é€Ÿ</span>
                                        <span class="badge bg-info">ä¸“æ³¨æ—¶åº</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="algorithm-card card text-center p-3 {% if algorithm == 'rf_mip_lstm' %}active{% endif %}" 
                                     onclick="selectAlgorithm('rf_mip_lstm')">
                                    {% if optimized_params.rf_mip_lstm.has_params %}
                                    <span class="optimization-badge">WOAä¼˜åŒ–</span>
                                    {% endif %}
                                    <div class="algorithm-icon text-success">
                                        <i class="bi bi-tree"></i>
                                    </div>
                                    <h5>RF-MIP-LSTM</h5>
                                    <p class="small text-muted mb-2">éšæœºæ£®æ—ç‰¹å¾é€‰æ‹© + å¤šè¾“å…¥LSTM</p>
                                    <div class="d-flex justify-content-center">
                                        <span class="badge bg-success me-1">é«˜ç²¾åº¦</span>
                                        <span class="badge bg-warning text-dark">å¤šç‰¹å¾</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- WOAä¼˜åŒ–é€‰é¡¹ - å·²ç§»åŠ¨åˆ°ç®—æ³•é€‰æ‹©åŒºåŸŸå†…éƒ¨ -->
                        <div class="mt-3 border-top pt-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="useOptimizedSwitch" checked>
                                <label class="form-check-label" for="useOptimizedSwitch">
                                    <i class="bi bi-magic text-primary"></i> ä½¿ç”¨WOAä¼˜åŒ–å‚æ•°
                                    {% if optimized_params[algorithm or 'lstm_map'].has_params %}
                                    <span class="badge bg-success ms-2">å·²ä¼˜åŒ–</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark ms-2">æœªä¼˜åŒ–</span>
                                    {% endif %}
                                </label>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> 
                                <span id="optimizationHint">
                                    {% if optimized_params[algorithm or 'lstm_map'].has_params %}
                                    ä½¿ç”¨WOAä¼˜åŒ–åçš„è¶…å‚æ•°ï¼Œé¢„æµ‹ç²¾åº¦æ›´é«˜
                                    {% else %}
                                    è¯¥ç®—æ³•å°šæœªä¼˜åŒ–ï¼Œç‚¹å‡»"å¯åŠ¨ä¼˜åŒ–"æŒ‰é’®è¿›è¡Œæ™ºèƒ½ä¼˜åŒ–
                                    {% endif %}
                                </span>
                            </small>
                        </div>

                        <!-- æ–°å¢ï¼šWOAä¼˜åŒ–çŠ¶æ€åŒºåŸŸ -->
                        <div class="mt-4 pt-3 border-top">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-gear"></i> WOAä¼˜åŒ–çŠ¶æ€
                            </h6>
                            
                            <!-- LSTM-MAPä¼˜åŒ–çŠ¶æ€ -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small>LSTM-MAP:</small>
                                {% if optimized_params.lstm_map.has_params %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> å·²ä¼˜åŒ–
                                </span>
                                {% else %}
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-exclamation-triangle"></i> å¾…ä¼˜åŒ–
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- RF-MIP-LSTMä¼˜åŒ–çŠ¶æ€ -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small>RF-MIP-LSTM:</small>
                                {% if optimized_params.rf_mip_lstm.has_params %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> å·²ä¼˜åŒ–
                                </span>
                                {% else %}
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-exclamation-triangle"></i> å¾…ä¼˜åŒ–
                                </span>
                                {% endif %}
                            </div>
                            
                            <button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="openOptimizationPanel()">
                                <i class="bi bi-magic"></i> å¯åŠ¨æ™ºèƒ½ä¼˜åŒ–
                            </button>
                        </div>
                    </div>
                </div>

                <form method="post" id="predictForm" class="mb-4">
                    <input type="hidden" name="algorithm" id="algorithmInput" value="{{ algorithm or 'lstm_map' }}">
                    <input type="hidden" name="use_optimized" id="useOptimizedInput" value="true">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="bi bi-search"></i> å“ç§ä»£ç 
                                </span>
                                <input type="text" class="form-control" name="symbol" id="symbolInput" 
                                       placeholder="å¦‚ RB0ã€AU0" value="{{ symbol or '' }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-secondary text-white">
                                    <i class="bi bi-calendar"></i> åºåˆ—é•¿åº¦
                                </span>
                                <select class="form-select" name="seq_len" id="seqLenSelect">
                                    <option value="30">30å¤©</option>
                                    <option value="40">40å¤©</option>
                                    <option value="50">50å¤©</option>
                                    <option value="60" selected>60å¤©</option>
                                    <option value="90">90å¤©</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <button type="submit" class="btn btn-success btn-lg px-5" id="submitBtn">
                            <span class="spinner-border spinner-border-sm d-none" id="loadingSpinner"></span>
                            <span id="btnText">
                                <i class="bi bi-robot"></i> 
                                {% if not algorithm or algorithm == 'lstm_map' %}
                                LSTM-MAP é¢„æµ‹
                                {% else %}
                                RF-MIP-LSTM é¢„æµ‹
                                {% endif %}
                            </span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-lg px-4 ms-3" onclick="getRealtimeOnly()">
                            <i class="bi bi-eye"></i> ä»…æŸ¥çœ‹å®æ—¶è¡Œæƒ…
                        </button>
                    </div>
                </form>

                {% if data %}
                <!-- é¢„æµ‹ç»“æœå±•ç¤ºåŒºåŸŸä¿æŒä¸å˜ -->
                <div class="price-chart-card shadow-lg mb-4">
                    <div class="{% if algorithm == 'rf_mip_lstm' %}bg-success{% else %}bg-primary{% endif %} text-white p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="mb-0">
                                    <i class="bi bi-graph-up me-2"></i>
                                    {{ data.symbol }} Â· {{ data.model_type }} 30å¤©é¢„æµ‹
                                    {% if data.used_optimized_params %}
                                    <span class="badge-woa badge ms-2">WOAä¼˜åŒ–</span>
                                    {% endif %}
                                </h3>
                                <small class="opacity-75">
                                    {% if algorithm == 'rf_mip_lstm' %}
                                    çº¢è‰²è™šçº¿ä¸ºRF-MIP-LSTMé¢„æµ‹ï¼Œè“è‰²ä¸ºå†å²ä»·æ ¼
                                    {% else %}
                                    çº¢è‰²è™šçº¿ä¸ºLSTM-MAPé¢„æµ‹ï¼Œè“è‰²ä¸ºå†å²ä»·æ ¼
                                    {% endif %}
                                    {% if data.used_optimized_params %}
                                    Â· ä½¿ç”¨WOAä¼˜åŒ–å‚æ•°
                                    {% endif %}
                                </small>
                            </div>
                            <div class="text-end">
                                <div class="model-badge {% if algorithm == 'rf_mip_lstm' %}badge-rf-mip-lstm{% else %}badge-lstm-map{% endif %}">
                                    {{ data.model_type }}
                                </div>
                                {% if data.confidence %}
                                <div class="text-white mt-1">
                                    ç½®ä¿¡åº¦: <strong>{{ "%.1f"|format(data.confidence * 100) }}%</strong>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <canvas id="priceChart" height="140"></canvas>
                    </div>
                </div>
                
                <!-- é¢„æµ‹è¯¦æƒ… -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header {% if algorithm == 'rf_mip_lstm' %}bg-success{% else %}bg-primary{% endif %} text-white">
                                <i class="bi bi-calendar-check"></i> è¿‘æœŸé¢„æµ‹ç»“æœ
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>æ—¥æœŸ</th>
                                            <th>é¢„æµ‹ä»·æ ¼</th>
                                            <th>å˜åŒ–</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for i in range(7) %}
                                        <tr>
                                            <td>{{ data.future_dates[i] }}</td>
                                            <td class="fw-bold">{{ "%.2f"|format(data.future_prices[i]) }}</td>
                                            <td class="{% if data.future_prices[i] > data.current_price %}change-up{% else %}change-down{% endif %}">
                                                {{ "%.2f"|format(data.future_prices[i] - data.current_price) }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <i class="bi bi-speedometer2"></i> æ¨¡å‹ä¿¡æ¯
                            </div>
                            <div class="card-body">
                                <p><strong>ç®—æ³•ç±»å‹:</strong> {{ data.model_type }}</p>
                                <p><strong>é¢„æµ‹å“ç§:</strong> {{ data.symbol }}</p>
                                <p><strong>é¢„æµ‹å¤©æ•°:</strong> 30å¤©</p>
                                <p><strong>æ¨¡å‹ç½®ä¿¡åº¦:</strong> {{ "%.1f"|format(data.confidence * 100) }}%</p>
                                <p><strong>æœ€æ–°ä»·æ ¼:</strong> {{ "%.2f"|format(data.current_price) }}</p>
                                <p class="{% if data.change >= 0 %}change-up{% else %}change-down{% endif %}">
                                    <strong>æ¶¨è·Œå¹…:</strong> 
                                    {{ "%.2f"|format(data.change) }} ({{ "%.2f"|format(data.change_pct) }}%)</p>
                                {% if data.used_optimized_params %}
                                <p class="text-success">
                                    <i class="bi bi-magic"></i> <strong>å·²ä½¿ç”¨WOAä¼˜åŒ–å‚æ•°</strong>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- å®æ—¶è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="realtimeDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">å®æ—¶è¡Œæƒ…è¯¦æƒ…</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <h3 id="detailSymbol">AU0</h3>
                    <h2 class="price-tag" id="detailPrice">0.00</h2>
                    <h4 id="detailChange" class="change-up">+0.00 (0.00%)</h4>
                </div>
                <table class="table table-bordered">
                    <tr>
                        <td>å“ç§åç§°</td>
                        <td id="detailName">-</td>
                    </tr>
                    <tr>
                        <td>ä»Šå¼€</td>
                        <td id="detailOpen">-</td>
                    </tr>
                    <tr>
                        <td>æœ€é«˜</td>
                        <td id="detailHigh">-</td>
                    </tr>
                    <tr>
                        <td>æœ€ä½</td>
                        <td id="detailLow">-</td>
                    </tr>
                    <tr>
                        <td>æ˜¨æ”¶</td>
                        <td id="detailPrevClose">-</td>
                    </tr>
                    <tr>
                        <td>æˆäº¤é‡</td>
                        <td id="detailVolume">-</td>
                    </tr>
                    <tr>
                        <td>æŒä»“é‡</td>
                        <td id="detailOpenInterest">-</td>
                    </tr>
                    <tr>
                        <td>æ›´æ–°æ—¶é—´</td>
                        <td id="detailTimestamp">-</td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="quickPredictFromModal()">
                    <i class="bi bi-robot"></i> AIé¢„æµ‹æ­¤å“ç§
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<!-- WOAä¼˜åŒ–é¢æ¿æ¨¡æ€æ¡† -->
<div class="modal fade" id="optimizationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">
                    <i class="bi bi-magic"></i> WOAæ™ºèƒ½ä¼˜åŒ–é¢æ¿
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6><i class="bi bi-info-circle"></i> é²¸é±¼ä¼˜åŒ–ç®—æ³•(WOA)è¯´æ˜</h6>
                    <p class="small text-muted">
                        WOAæ¨¡æ‹Ÿåº§å¤´é²¸çš„æ³¡ç½‘æ•é£Ÿç­–ç•¥ï¼Œè‡ªåŠ¨æœç´¢LSTM/RF-MIP-LSTMçš„æœ€ä½³è¶…å‚æ•°ç»„åˆã€‚
                        ä¼˜åŒ–è¿‡ç¨‹éœ€è¦3-5åˆ†é’Ÿï¼Œä¼˜åŒ–åçš„å‚æ•°å°†æ˜¾è‘—æå‡é¢„æµ‹ç²¾åº¦ã€‚
                    </p>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <i class="bi bi-lightning-charge"></i> ä¼˜åŒ–LSTM-MAP
                            </div>
                            <div class="card-body">
                                <h6>ä¼˜åŒ–å‚æ•°:</h6>
                                <ul class="small">
                                    <li>éšè—å±‚å¤§å° (32-128)</li>
                                    <li>LSTMå±‚æ•° (1-3)</li>
                                    <li>æ³¨æ„åŠ›å¤´æ•° (2-8)</li>
                                    <li>Dropoutç‡ (0.1-0.5)</li>
                                    <li>å­¦ä¹ ç‡ (0.0001-0.01)</li>
                                </ul>
                                <div class="mt-3">
                                    <select class="form-select mb-2" id="lstmSymbolSelect">
                                        <option value="AU0">é»„é‡‘ (AU0)</option>
                                        <option value="AG0">ç™½é“¶ (AG0)</option>
                                        <option value="RB0">èºçº¹é’¢ (RB0)</option>
                                        <option value="SC0">åŸæ²¹ (SC0)</option>
                                    </select>
                                    <button class="btn btn-primary w-100" onclick="startOptimization('lstm_map')">
                                        <i class="bi bi-play-circle"></i> å¯åŠ¨LSTM-MAPä¼˜åŒ–
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <i class="bi bi-tree"></i> ä¼˜åŒ–RF-MIP-LSTM
                            </div>
                            <div class="card-body">
                                <h6>ä¼˜åŒ–å‚æ•°:</h6>
                                <ul class="small">
                                    <li>éšè—å±‚å¤§å° (32-128)</li>
                                    <li>LSTMå±‚æ•° (1-3)</li>
                                    <li>Dropoutç‡ (0.1-0.5)</li>
                                    <li>å­¦ä¹ ç‡ (0.0001-0.01)</li>
                                    <li>åºåˆ—é•¿åº¦ (30-90)</li>
                                </ul>
                                <div class="mt-3">
                                    <select class="form-select mb-2" id="rfSymbolSelect">
                                        <option value="AU0">é»„é‡‘ (AU0)</option>
                                        <option value="AG0">ç™½é“¶ (AG0)</option>
                                        <option value="RB0">èºçº¹é’¢ (RB0)</option>
                                        <option value="SC0">åŸæ²¹ (SC0)</option>
                                    </select>
                                    <button class="btn btn-success w-100" onclick="startOptimization('rf_mip_lstm')">
                                        <i class="bi bi-play-circle"></i> å¯åŠ¨RF-MIP-LSTMä¼˜åŒ–
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ä¼˜åŒ–çŠ¶æ€æ˜¾ç¤º -->
                <div class="mt-4" id="optimizationStatusContainer" style="display: none;">
                    <h6><i class="bi bi-hourglass-split"></i> ä¼˜åŒ–ä»»åŠ¡çŠ¶æ€</h6>
                    <div class="optimization-status status-running" id="optimizationStatus">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong id="statusTaskName">ä»»åŠ¡åç§°</strong>
                                <div class="small" id="statusMessage">æ­£åœ¨åˆå§‹åŒ–...</div>
                            </div>
                            <div>
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                <span id="statusProgress">0%</span>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 5px;">
                            <div id="statusProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ä¼˜åŒ–å†å² -->
                <div class="mt-4">
                    <h6><i class="bi bi-clock-history"></i> ä¼˜åŒ–å†å²</h6>
                    <div id="optimizationHistory">
                        <!-- åŠ¨æ€åŠ è½½ä¼˜åŒ–å†å² -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- è„šæœ¬ -->
<script>
let currentAlgorithm = "{{ algorithm or 'lstm_map' }}";
let currentTaskId = null;
let optimizationInterval = null;

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    updateTime();
    setInterval(updateTime, 60000);
    
    // åˆå§‹åŠ è½½æ‰€æœ‰å®æ—¶æ•°æ®
    refreshAllRealtime();
    
    // è®¾ç½®å®šæ—¶åˆ·æ–°
    setInterval(refreshAllRealtime, 300000);
    
    {% if data and data.seq_len %}
    document.getElementById('seqLenSelect').value = {{ data.seq_len or 60 }};
    {% endif %}
    
    // åˆå§‹åŒ–ç®—æ³•é€‰æ‹©
    updateAlgorithmUI();
    
    // åˆå§‹åŒ–ä¼˜åŒ–é€‰é¡¹
    updateOptimizationUI();
    
    // åŠ è½½ä¼˜åŒ–å†å²
    loadOptimizationHistory();
});

function updateTime() {
    const now = new Date();
    document.getElementById('updateTime').textContent = 
        now.toLocaleTimeString('zh-CN');
}

// é€‰æ‹©ç®—æ³•
function selectAlgorithm(algorithm) {
    currentAlgorithm = algorithm;
    document.getElementById('algorithmInput').value = algorithm;
    updateAlgorithmUI();
    updateOptimizationUI();
}

function updateAlgorithmUI() {
    // æ›´æ–°ç®—æ³•å¡ç‰‡çŠ¶æ€
    document.querySelectorAll('.algorithm-card').forEach(card => {
        card.classList.remove('active');
    });
    
    const activeCard = document.querySelector(`[onclick="selectAlgorithm('${currentAlgorithm}')"]`);
    if (activeCard) {
        activeCard.classList.add('active');
    }
    
    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    const btnText = document.getElementById('btnText');
    if (currentAlgorithm === 'rf_mip_lstm') {
        btnText.innerHTML = '<i class="bi bi-robot"></i> RF-MIP-LSTM é¢„æµ‹';
    } else {
        btnText.innerHTML = '<i class="bi bi-robot"></i> LSTM-MAP é¢„æµ‹';
    }
}

function updateOptimizationUI() {
    // æ›´æ–°ä¼˜åŒ–å¼€å…³çŠ¶æ€
    const optimizedParams = {{ optimized_params|tojson }};
    const hasOptimized = optimizedParams[currentAlgorithm]?.has_params || false;
    
    document.getElementById('optimizationHint').textContent = 
        hasOptimized 
            ? 'ä½¿ç”¨WOAä¼˜åŒ–åçš„è¶…å‚æ•°ï¼Œé¢„æµ‹ç²¾åº¦æ›´é«˜'
            : 'è¯¥ç®—æ³•å°šæœªä¼˜åŒ–ï¼Œç‚¹å‡»"å¯åŠ¨ä¼˜åŒ–"æŒ‰é’®è¿›è¡Œæ™ºèƒ½ä¼˜åŒ–';
}

// æ‰“å¼€ä¼˜åŒ–é¢æ¿
function openOptimizationPanel() {
    const modal = new bootstrap.Modal(document.getElementById('optimizationModal'));
    modal.show();
}

// å¯åŠ¨ä¼˜åŒ–ä»»åŠ¡
function startOptimization(algorithm) {
    const symbolSelect = algorithm === 'lstm_map' ? 
        document.getElementById('lstmSymbolSelect') : 
        document.getElementById('rfSymbolSelect');
    
    const symbol = symbolSelect.value;
    
    // æ˜¾ç¤ºçŠ¶æ€å®¹å™¨
    document.getElementById('optimizationStatusContainer').style.display = 'block';
    
    const algorithmName = algorithm === 'lstm_map' ? 'LSTM-MAP' : 'RF-MIP-LSTM';
    document.getElementById('statusTaskName').textContent = `${algorithmName} - ${symbol}`;
    document.getElementById('statusMessage').textContent = 'æ­£åœ¨å¯åŠ¨ä¼˜åŒ–ä»»åŠ¡...';
    
    // å‘é€ä¼˜åŒ–è¯·æ±‚
    fetch(`/api/optimize/${algorithm}/${symbol}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentTaskId = data.task_id;
            document.getElementById('statusMessage').textContent = 'ä¼˜åŒ–ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ­£åœ¨è¿è¡Œ...';
            
            // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
            startPollingTaskStatus();
        } else {
            document.getElementById('statusMessage').textContent = `å¯åŠ¨å¤±è´¥: ${data.error}`;
            document.getElementById('optimizationStatus').className = 'optimization-status status-failed';
        }
    })
    .catch(error => {
        document.getElementById('statusMessage').textContent = `è¯·æ±‚å¤±è´¥: ${error}`;
        document.getElementById('optimizationStatus').className = 'optimization-status status-failed';
    });
}

// å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
function startPollingTaskStatus() {
    if (optimizationInterval) {
        clearInterval(optimizationInterval);
    }
    
    optimizationInterval = setInterval(() => {
        fetch(`/api/optimization_status/${currentTaskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const status = data.status;
                    const progress = data.progress || 0;
                    
                    // æ›´æ–°è¿›åº¦
                    document.getElementById('statusProgress').textContent = `${progress}%`;
                    document.getElementById('statusProgressBar').style.width = `${progress}%`;
                    
                    if (status === 'running') {
                        document.getElementById('optimizationStatus').className = 'optimization-status status-running';
                        document.getElementById('statusMessage').textContent = 
                            `æ­£åœ¨ä¼˜åŒ–ä¸­... (è¿­ä»£ ${Math.floor(progress/5)}/20)`;
                    } 
                    else if (status === 'completed') {
                        document.getElementById('optimizationStatus').className = 'optimization-status status-completed';
                        document.getElementById('statusMessage').textContent = 
                            `ä¼˜åŒ–å®Œæˆ! è€—æ—¶ ${data.duration ? data.duration.toFixed(1) : '?'} ç§’`;
                        document.getElementById('statusProgress').textContent = '100%';
                        document.getElementById('statusProgressBar').style.width = '100%';
                        
                        // åœæ­¢è½®è¯¢
                        clearInterval(optimizationInterval);
                        
                        // é‡æ–°åŠ è½½é¡µé¢ä»¥æ˜¾ç¤ºæ›´æ–°çŠ¶æ€
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    }
                    else if (status === 'failed') {
                        document.getElementById('optimizationStatus').className = 'optimization-status status-failed';
                        document.getElementById('statusMessage').textContent = 
                            `ä¼˜åŒ–å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`;
                        
                        // åœæ­¢è½®è¯¢
                        clearInterval(optimizationInterval);
                    }
                }
            })
            .catch(error => {
                console.error('è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
            });
    }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
}

// åŠ è½½ä¼˜åŒ–å†å²
function loadOptimizationHistory() {
    // è¿™é‡Œå¯ä»¥æ·»åŠ åŠ è½½ä¼˜åŒ–å†å²çš„é€»è¾‘
    // ç°åœ¨åªæ˜¯æ˜¾ç¤ºç¤ºä¾‹
    const historyContainer = document.getElementById('optimizationHistory');
    historyContainer.innerHTML = `
        <div class="small text-muted">
            <i class="bi bi-info-circle"></i> ä¼˜åŒ–å†å²å°†åœ¨ä¼˜åŒ–å®Œæˆåæ˜¾ç¤º
        </div>
    `;
}

// åˆ·æ–°å•ä¸ªå“ç§çš„å®æ—¶æ•°æ®
function refreshSymbol(symbol, event) {
    if (event) event.stopPropagation();
    
    const element = document.getElementById(`realtime-${symbol}`);
    if (!element) return;
    
    element.innerHTML = `
        <div class="text-center py-2">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <div class="mt-1 small">åˆ·æ–°ä¸­...</div>
        </div>
    `;
    
    fetch(`/api/realtime/${symbol}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const changeClass = data.change >= 0 ? 'change-up' : 'change-down';
                const changeIcon = data.change >= 0 ? 'â†‘' : 'â†“';
                const volume = data.volume ? Math.floor(data.volume / 10000) : 0;
                
                element.innerHTML = `
                    <div class="price-tag">${data.current_price.toFixed(2)}</div>
                    <div class="${changeClass} fw-bold fs-6">
                        ${changeIcon}${Math.abs(data.change).toFixed(2)} 
                        (${data.change_pct.toFixed(2)}%)
                    </div>
                    <div class="badge badge-volume bg-light text-dark mt-1">
                        é‡ ${volume}ä¸‡
                    </div>
                `;
            } else {
                element.innerHTML = `
                    <div class="text-danger small">
                        <i class="bi bi-exclamation-triangle"></i> åˆ·æ–°å¤±è´¥
                    </div>
                `;
            }
        })
        .catch(error => {
            element.innerHTML = `
                <div class="text-danger small">
                    <i class="bi bi-exclamation-triangle"></i> ç½‘ç»œé”™è¯¯
                </div>
            `;
        });
}

// åˆ·æ–°æ‰€æœ‰å“ç§çš„å®æ—¶æ•°æ®
function refreshAllRealtime() {
    console.log('åˆ·æ–°æ‰€æœ‰å®æ—¶æ•°æ®...');
    const symbols = ['AU0', 'AG0', 'CU0', 'RB0', 'SC0', 'BU0', 'M0', 'TA0', 'MA0', 'NI0'];
    
    symbols.forEach(symbol => {
        refreshSymbol(symbol);
    });
    
    updateTime();
}

// æ˜¾ç¤ºå®æ—¶è¯¦æƒ…æ¨¡æ€æ¡†
function showRealtimeDetail(symbol) {
    const modal = new bootstrap.Modal(document.getElementById('realtimeDetailModal'));
    const config = {{ futures_config|tojson }};
    
    document.getElementById('detailSymbol').textContent = symbol;
    document.getElementById('modalTitle').textContent = `${config[symbol]?.name || symbol} å®æ—¶è¡Œæƒ…`;
    document.getElementById('detailName').textContent = config[symbol]?.name || '-';
    
    fetch(`/api/realtime/${symbol}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('detailPrice').textContent = data.current_price.toFixed(2);
                
                const changeElement = document.getElementById('detailChange');
                changeElement.textContent = `${data.change >= 0 ? '+' : ''}${data.change.toFixed(2)} (${data.change_pct.toFixed(2)}%)`;
                changeElement.className = data.change >= 0 ? 'change-up' : 'change-down';
            } else {
                document.getElementById('detailPrice').textContent = '0.00';
                document.getElementById('detailChange').textContent = 'æ•°æ®è·å–å¤±è´¥';
            }
        });
    
    modal.show();
}

// ä»æ¨¡æ€æ¡†è¿›è¡Œé¢„æµ‹
function quickPredictFromModal() {
    const symbol = document.getElementById('detailSymbol').textContent;
    quickPredict(symbol);
    bootstrap.Modal.getInstance(document.getElementById('realtimeDetailModal')).hide();
}

// ä»…æŸ¥çœ‹å®æ—¶è¡Œæƒ…ï¼ˆä¸è¿›è¡Œé¢„æµ‹ï¼‰
function getRealtimeOnly() {
    const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
    if (!symbol) {
        alert('è¯·è¾“å…¥å“ç§ä»£ç ');
        return;
    }
    
    showRealtimeDetail(symbol);
}

function quickPredict(code) {
    document.getElementById('symbolInput').value = code;
    
    // æ ¹æ®å“ç§ç±»åˆ«è®¾ç½®é»˜è®¤åºåˆ—é•¿åº¦
    const card = document.querySelector(`[data-symbol="${code}"]`);
    if (card && card.dataset.category) {
        const category = card.dataset.category;
        const seqLenMap = {
            'metal': '60',
            'energy': '40',
            'agri': '50',
            'chem': '40'
        };
        document.getElementById('seqLenSelect').value = seqLenMap[category] || '60';
    }
    
    // è·å–ä¼˜åŒ–é€‰é¡¹
    const useOptimized = document.getElementById('useOptimizedSwitch').checked;
    document.getElementById('useOptimizedInput').value = useOptimized;
    
    // æäº¤è¡¨å•
    document.getElementById('loadingSpinner').classList.remove('d-none');
    const btnText = document.getElementById('btnText');
    btnText.innerHTML = currentAlgorithm === 'rf_mip_lstm' 
        ? `<i class="bi bi-robot"></i> ${useOptimized ? 'WOAä¼˜åŒ– ' : ''}RF-MIP-LSTMé¢„æµ‹ ${code}...`
        : `<i class="bi bi-robot"></i> ${useOptimized ? 'WOAä¼˜åŒ– ' : ''}LSTM-MAPé¢„æµ‹ ${code}...`;
    
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('predictForm').submit();
}

document.getElementById('predictForm').addEventListener('submit', function() {
    if (!document.getElementById('loadingSpinner').classList.contains('d-none')) return;
    document.getElementById('loadingSpinner').classList.remove('d-none');
    
    const useOptimized = document.getElementById('useOptimizedSwitch').checked;
    const btnText = document.getElementById('btnText');
    btnText.innerHTML = currentAlgorithm === 'rf_mip_lstm'
        ? `<i class="bi bi-robot"></i> ${useOptimized ? 'WOAä¼˜åŒ– ' : ''}RF-MIP-LSTM åˆ†æä¸­...`
        : `<i class="bi bi-robot"></i> ${useOptimized ? 'WOAä¼˜åŒ– ' : ''}LSTM-MAP åˆ†æä¸­...`;
    
    document.getElementById('submitBtn').disabled = true;
});
</script>

{% if data %}
<script>
const ctx = document.getElementById('priceChart').getContext('2d');

const futurePrices = {{ data.future_prices|tojson }};
const histPrices = {{ data.hist_prices|tojson }};
const histDates = {{ data.hist_dates|tojson }};
const futureDates = {{ data.future_dates|tojson }};

// å›¾è¡¨é…ç½®
const chartConfig = {
    type: 'line',
    data: {
        labels: [...histDates, ...futureDates],
        datasets: [
            {
                label: 'å†å²ä»·æ ¼',
                data: [...histPrices, ...Array(futurePrices.length).fill(null)],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 2
            },
            {
                label: '{{ data.model_type }} é¢„æµ‹',
                data: [...Array(histPrices.length).fill(null), ...futurePrices],
                borderColor: '#dc3545',
                borderWidth: 4,
                borderDash: [8, 4],
                pointRadius: 3,
                tension: 0.2
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    font: { size: 14 },
                    usePointStyle: true
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            label += context.parsed.y.toFixed(2);
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                grid: {
                    color: 'rgba(0,0,0,0.05)'
                },
                title: {
                    display: true,
                    text: 'ä»·æ ¼'
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    maxTicksLimit: 15
                }
            }
        },
        interaction: {
            intersect: false,
            mode: 'nearest'
        },
        animation: {
            duration: 2000
        }
    }
};

new Chart(ctx, chartConfig);
</script>
{% endif %}
</body>
</html>
[file content end]